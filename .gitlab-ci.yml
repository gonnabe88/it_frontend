# 1. 백신 검사
virus_scan:
  stage: scan
  image: clamav/clamav:latest
  script:
    - freshclam || true 
    - clamscan -r . --log=clamav-result.txt
    # 백신 검사 통과 증명서 생성
    - echo "VIRUS_FREE" > virus_result.txt
  artifacts:
    paths:
      - virus_result.txt
  allow_failure: false # 통제를 위해 false로 설정

# 2. 오픈소스 취약점 점검
osv_scan:
  stage: scan
  image:
    name: ghcr.io/aquasecurity/trivy:latest
    entrypoint: ["/bin/sh", "-c"]
  script:
    - trivy fs --severity HIGH,CRITICAL --exit-code 1 .
    # 취약점 점검 통과 증명서 생성
    - echo "SCAN_PASSED" > scan_result.txt
  artifacts:
    paths:
      - scan_result.txt
  allow_failure: false

# 3. 내부 저장소 미러링 (통제 게이트)
internal_mirror:
  stage: mirror
  needs: 
    - job: virus_scan
      artifacts: true
    - job: osv_scan
      artifacts: true
  script:
    # 두 파일이 모두 있는지 최종 검증
    - if [ ! -f virus_result.txt ] || [ ! -f scan_result.txt ]; then echo "보안 점검 누락!"; exit 1; fi
    - echo "백신 및 취약점 점검 모두 통과. 미러링을 시작합니다."
    # - git push --mirror ...
  only:
    - main