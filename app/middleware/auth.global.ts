/**
 * ============================================================================
 * [middleware/auth.global.ts] 전역 인증 라우트 미들웨어
 * ============================================================================
 * 파일명의 '.global' 접미사로 인해 Nuxt가 모든 라우트 네비게이션에
 * 자동으로 적용하는 전역 미들웨어입니다.
 *
 * [처리 흐름]
 *  1. SSR 환경 감지 → 서버 사이드에서는 실행하지 않고 즉시 반환
 *     (localStorage는 브라우저에서만 접근 가능)
 *  2. restoreSession() 호출 → localStorage에서 이전 세션 복원
 *  3. 목적지(to) 라우트 분기 처리:
 *     - /login 페이지:
 *       - 이미 로그인된 상태이면 홈('/')으로 리다이렉트 (로그인 페이지 진입 차단)
 *       - 미로그인 상태이면 정상 접근 허용 (로그인 폼 표시)
 *     - 그 외 페이지:
 *       - 인증되지 않은 상태이면 /login으로 리다이렉트 (인증 가드)
 *       - 인증된 상태이면 정상 접근 허용
 *
 * [restoreSession 호출 위치]
 *  - 이 미들웨어에서만 호출합니다.
 *  - app.vue에서의 중복 호출은 제거되었습니다.
 *
 * [적용 대상]
 *  - 앱의 모든 페이지 네비게이션 (초기 진입 포함)
 * ============================================================================
 */
export default defineNuxtRouteMiddleware((to, from) => {
    /**
     * SSR 환경 분기
     * localStorage는 브라우저에서만 사용 가능합니다.
     * 서버 사이드 렌더링 시에는 세션 복원 및 인증 체크를 건너뜁니다.
     */
    if (import.meta.server) return;

    // useAuth composable에서 인증 상태 및 세션 복원 함수 가져오기
    const { isAuthenticated, restoreSession } = useAuth();

    /**
     * 세션 복원 시도
     * 페이지 새로고침 후 Pinia 상태가 초기화된 경우,
     * localStorage에 저장된 토큰과 사용자 정보로 상태를 복원합니다.
     * 이미 로그인된 상태라면 아무 동작도 하지 않습니다.
     */
    restoreSession();

    /**
     * /login 페이지 접근 처리
     * - 이미 인증된 사용자가 /login에 접근하면 홈으로 리다이렉트합니다.
     *   (로그인된 상태에서 브라우저 주소창으로 직접 접근하는 경우 처리)
     * - 미인증 사용자는 정상적으로 로그인 페이지를 볼 수 있습니다.
     */
    if (to.path === '/login') {
        if (isAuthenticated.value) {
            // 이미 로그인된 경우 메인 페이지로 리다이렉트
            return navigateTo('/');
        }
        return; // 미로그인 → 로그인 페이지 정상 표시
    }

    /**
     * 일반 페이지 인증 가드
     * 인증되지 않은 사용자가 보호된 페이지에 접근하려 할 때 /login으로 리다이렉트합니다.
     * 인증된 사용자는 아무런 제한 없이 접근 가능합니다.
     */
    if (!isAuthenticated.value) {
        return navigateTo('/login');
    }
});
